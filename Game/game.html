<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Игра</title>
</head>
<body>
    <main>
        <div class="section-list">
            <div class="first section current">
                <form class="submit-field">
                    <input type="text" minlength="4" placeholder="Введите имя пользователя" class="input-field">
                    <button type="submit" class="submit-btn submit-name">Начать</button>
                </form> 
                <a href="./index.html"><button type="button" class="return-btn">Выход</button></a>
            </div>
            <div class="second section ">
                <div class="info">
                    <h1>Для того чтобы пройти каждый из этапов нужно набрать минимум 10 баллов</h1>
                    <button type="button" class="start">Начать</button>
                    <a href="./index.html"><button type="button" class="exit-btn exit">Выход</button></a>
                </div>
                
            </div>
            <div class="third section">
                <div class="info-container">
                    <p class="p-info">Время</p>
                    <p class="counter1 p-info"></p>
                    <p class="p-info">Счет</p>
                    <p class="score1 p-info">0</p>
                </div>
                <div class="game-field">
                    <h1>Нажми на повернутую картинку</h1>
                    <h1 class="res"></h1>
                    <div class="image-list">
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                    </div>
                </div>
            </div>
            <div class="fail section">
                <div class="info">
                    <p class="text">Вы проиграли</p>
                    <a href="./index.html"><button type="button" class="return-btn">Выход</button></a>
                </div>
            </div>
            <div class="win-1 section ">
                <div class="info">
                    <p class="text">Вы прошли уровень</p>
                    <button type="button" class="next-btn-1">Следующий уровень: 2</button>
                </div>
            </div>
            <div class="fourth section ">
                <div class="info-container">
                    <p class="p-info">Время</p>
                    <p class="counter2 p-info"></p>
                    <p class="p-info">Счет</p>
                    <p class="score2 p-info">0</p>
                    <p class="p-info">Общий счет</p>
                    <p class="total-score p-info"></p>
                </div>
                <div class="game-field"> 
                    <h1>Разделите животных на хищников и травоядных</h1>
                    <div class="game-2-container">
                        <div class="cont-center">
                            <h1 class="first-text"></h1>
                            <div id="div1" class="game-container left" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                        </div>
                        <div class="cont-center">
                            <h1 class="second-text"></h1>
                            <div id="div2" class="game-container right" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                        </div>
                    </div>
                    <div class="image-list game2-list">
                        <div id="drag1" class="img" draggable="true" ondragstart="drag(event)"></div>
                        <div id="drag2" class="img" draggable="true" ondragstart="drag(event)"></div>
                        <div id="drag3" class="img" draggable="true" ondragstart="drag(event)"></div>
                        <div id="drag4" class="img" draggable="true" ondragstart="drag(event)"></div>
                        <div id="drag5" class="img" draggable="true" ondragstart="drag(event)"></div>
                        <div id="drag6" class="img" draggable="true" ondragstart="drag(event)"></div>
                    </div>
                </div>
            </div>
            <div class="win-2 section">
                <div class="info">
                    <p class="text">Вы прошли уровень</p>
                    <button type="button" class="next-btn-2">Следующий уровень: 3</button>
                </div>
            </div>
            <div class="fiveth section ">
                <div class="info-container">
                    <p class="p-info">Время</p>
                    <p class="counter3 p-info"></p>
                    <p class="p-info">Счет</p>
                    <p class="score3 p-info">0</p>
                    <p class="p-info">Общий счет</p>
                    <p class="total-score p-info"></p>
                </div>
                <div class="game-field"> 
                    <h1>Нажмите на указанное животное</h1>
                    <h1 class="request"></h1>
                    <div class="image-list game3-list">
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                        <div class="img"></div>
                    </div>
                </div>
            </div>
            <div class="win-3 section ">
                <div class="info">
                    <p class="text">Поздравляем! <br> Вы прошли все уровни</p>
                    <p class="p-info">Ваш общий счет</p>
                    <p class="total-score p-info"></p>
                    <a href="./index.html"><button type="button" class="exit-btn exit">Выход</button></a>
                </div>
            </div>
        </div>
        
    </main>
    <script>
        let submitName = document.querySelector('form');
        let input = document.querySelector('input');
        let user = {name: '', score: 0}
        let first = document.querySelector('.first');
        let second = document.querySelector('.second');
        let third = document.querySelector('.third');
        let fourth = document.querySelector('.fourth');
        let fiveth = document.querySelector('.fiveth');
        let fail = document.querySelector('.fail');
        let win1 = document.querySelector('.win-1');
        let win2 = document.querySelector('.win-2');
        let win3 = document.querySelector('.win-3');
        let totalScore = document.querySelectorAll('.total-score');
        totalScore.textContent = "0";


        submitName.addEventListener('submit', (e) => {
            if(input.value.length == 0){
                window.alert("Поле ввода пустое")
                return;
            }
            e.preventDefault();
            let userExist = false;
            let userName = input.value;
            user.name = userName;
            for (let i = 0; i < localStorage.length; i++) {
                let uJson = JSON.parse(localStorage.getItem(localStorage.key(i)));
                if (userName == uJson.name) {
                    userExist = true;
                    break;
                }
            }
            if (!userExist) {
                localStorage.setItem('user' + localStorage.length, JSON.stringify(user));
            }
            first.classList.toggle('current');
            second.classList.toggle('current');
        });

        

        let start = document.querySelector('.start');
        
        let counter;
        let counterValue1= document.querySelector('.counter1');
        let timeValue;
        let min;
        let sec;
        
        
        let scoreEl1 = document.querySelector('.score1');
        
        start.addEventListener('click', (e) => {
            second.classList.toggle('current');
            third.classList.toggle('current');
            timeValue = 60;
            counter = setInterval(function () {
                min = Math.floor(timeValue / 60);
                sec = timeValue % 60;
                if (timeValue == 0) {
                    user.score = Number(scoreEl1.textContent);
                    for (let i = 0; i < localStorage.length; i++) {
                        
                        let userJson = JSON.parse(localStorage.getItem(localStorage.key(i)));
                        if ((user.name == userJson.name) && (user.score > userJson.score)) {
                            let key = localStorage.key(i);
                            localStorage.removeItem(localStorage.key(i));
                            localStorage.setItem(key, JSON.stringify(user));
                            break;
                        }
                    }
                    if (Number(scoreEl1.textContent) >= 10) {
                        setTimeout(() => {
                            clearInterval(counter);
                            totalScore[0].textContent = (Number(totalScore[0].textContent) + Number(scoreEl1.textContent));
                            third.classList.toggle('current');
                            win1.classList.toggle('current');
                        }, 500)
                    }else if(Number(scoreEl1.textContent) < 10) {
                        setTimeout(() => {
                            clearInterval(counter);
                            third.classList.toggle('current');
                            fail.classList.toggle('current');
                        }, 500)
                    }
                }
                let str = '0' + min + ':';
                str += sec >= 10 ? sec :'0'+ sec;
                counterValue1.innerHTML = str;
                timeValue--;
            }, 1000)
            getImages();
        });

        let exit = document.querySelector('.exit');
        exit.addEventListener = ('click', (e) => {
            clearInterval(counter);
            if (localStorage.length > 0) {
                for (let i = 0; i < localStorage.length; i++) {
                    let userJson = JSON.parse(localStorage.getItem(localStorage.key(i)));
                    if ((user.name == userJson.name) && (user.score > userJson.score)) {
                        let key = localStorage.key(i);
                        localStorage.removeItem(localStorage.key(i));
                        localStorage.setItem(key, JSON.stringify(user));
                        break;
                    }
                }
            }
        });


        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min) + min);
        }

        
        let imageList = document.querySelector(".image-list");
        let length = imageList.children.length;
        let correctImg = getRandomInt(0,length);
        function getImages() {
            for (let i = 0; i < imageList.children.length; i++){
                imageList.children[i].style.transform = "rotate(0deg)";
                imageList.children[i].classList.add(`image-${i+1}`);
            }
            let rotate = getRandomInt(1,4)*90;
            imageList.children[correctImg].style.transform = `rotate(${rotate}deg)`;
        }
        function getDeg(el) {
            let style = window.getComputedStyle(el, null);
            let styleMatrix = style.getPropertyValue("transform");
            if (styleMatrix == 'none') return 0;
            let transformArr = styleMatrix.split('(')[1];
            transformArr = transformArr.split(')')[0];
            transformArr = transformArr.split(',');
            transformArr = transformArr.slice(0,2);
            let cos = transformArr[0];
            let sin = transformArr[1];
            let deg = Math.round(Math.asin(sin)/ Math.PI * (180));

            if (cos < 0) {
                let addDeg = 180 - Math.round(Math.asin(sin)/ Math.PI * (180));
                deg = addDeg;
            }
            return deg;
        }
        for (let i = 0; i < imageList.children.length; i++) {
            imageList.children[i].onclick = function () {
                if (getDeg(imageList.children[i]) != 0) {
                    scoreEl1.textContent = Number(scoreEl1.textContent) + 1;
                } else {
                    scoreEl1.textContent = Number(scoreEl1.textContent) - 1;
                }
                correctImg = getRandomInt(0,length);
                setTimeout(getImages, 600);
            }
        }

        ///////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////

        function getRandomOrder1(array) {
            let childrenArray = Array.from(array.children);
            childrenArray.sort(function(a, b) {
                return Math.random() - 0.5;
            });
            while (array.firstChild) {
                array.removeChild(array.firstChild);
            }
            childrenArray.forEach(function(child) {
                array.appendChild(child);
            });
        }


        let randomTask = getRandomInt(0, 3);
        let left = document.querySelector(".left");
        let right = document.querySelector(".right");
        let firstText = document.querySelector(".first-text");
        let secondText = document.querySelector(".second-text");
        
        function getImages1() {
            for (let i = 0; i < game2list.children.length; i++){
                game2list.children[i].classList.add(`image-${i+1}`);
            }
            game2list.children[0].classList.add("одомашненное", "травоядное", "безрогое");
            game2list.children[1].classList.add("дикое", "хищник", "безрогое");
            game2list.children[2].classList.add("одомашненное", "травоядное", "рогатое");
            game2list.children[3].classList.add("дикое", "хищник", "безрогое");
            game2list.children[4].classList.add("дикое", "травоядное", "рогатое");
            game2list.children[5].classList.add("одомашненное", "хищник", "безрогое");
            getTask();
        }
        function getTask(){
            if(randomTask == 0){
                firstText.textContent = "Хищники";
                secondText.textContent = "Травоядные";
                if (left.classList.length == 3){
                    left.classList.replace(left.classList[2], "хищник");
                } else{
                    left.classList.add("хищник");
                }
                if (right.classList.length == 3){
                    right.classList.replace(right.classList[2], "травоядное");
                } else{
                    right.classList.add("травоядное");
                }
            } 
            else if(randomTask == 1){
                firstText.textContent = "Дикие";
                secondText.textContent = "Одомашненные";
                if (left.classList.length == 3){
                    left.classList.replace(left.classList[2], "дикое");
                } else{
                    left.classList.add("дикое");
                }
                if (right.classList.length == 3){
                    right.classList.replace(right.classList[2], "одомашненное");
                } else{
                    right.classList.add("одомашненное");
                }
            } 
            else if(randomTask == 2){
                firstText.textContent = "Рогатые";
                secondText.textContent = "Безрогие";
                if (left.classList.length == 3){
                    left.classList.replace(left.classList[2], "рогатое");
                } else{
                    left.classList.add("рогатое");
                }
                if (right.classList.length == 3){
                    right.classList.replace(right.classList[2], "безрогое");
                } else{
                    right.classList.add("безрогое");
                }
            }
        }


        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        let game2list = document.querySelector(".game2-list");
        
        

        checkLeft = function(tempLeft){
            for(let i = 0; i < tempLeft.children.length; i++){
                if (!(tempLeft.children[i].classList.contains(tempLeft.classList[2]))){
                    return false;
                }
                return true;
            }
        }
        checkRight = function(tempRight){
            for(let i = 0; i < tempRight.children.length; i++){
                if (!(tempRight.children[i].classList.contains(tempRight.classList[2]))){
                    return false;
                }
                return true;
            }
        }
        checkGame2list = function(tempGame2list){
            if (tempGame2list.children.length != 0){
                return false;
            }
            return true;
        }


        function drop(ev) {
            ev.preventDefault();
            let data = ev.dataTransfer.getData("text");
            ev.target.appendChild(document.getElementById(data));
            if ((checkGame2list(game2list))){
                if((checkLeft(left))&&(checkRight(right))){
                    scoreEl2.textContent = Number(scoreEl2.textContent) + 1;
                }else{
                    scoreEl2.textContent = Number(scoreEl2.textContent) - 1;
                }
                
                game2list.innerHTML += left.innerHTML;
                game2list.innerHTML += right.innerHTML;
                getRandomOrder1(game2list);
                left.innerHTML = "";
                right.innerHTML = "";
                randomTask = getRandomInt(0,3);
                getTask();
            }
        }

        
            

        let nextBtn1 = document.querySelector(".next-btn-1");
        let scoreEl2 = document.querySelector('.score2');
        let counterValue2= document.querySelector('.counter2');
        nextBtn1.addEventListener('click', (e) => {
            scoreEl2.textContent = "0";
            win1.classList.toggle('current');
            fourth.classList.toggle('current');
            timeValue = 90;
            counter = setInterval(function () {
                min = Math.floor(timeValue / 60);
                sec = timeValue % 60;
                if (timeValue == 0) {
                    user.score += Number(scoreEl2.textContent);
                    for (let i = 0; i < localStorage.length; i++) {
                        
                        let userJson = JSON.parse(localStorage.getItem(localStorage.key(i)));
                        if ((user.name == userJson.name) && (user.score > userJson.score)) {
                            let key = localStorage.key(i);
                            localStorage.removeItem(localStorage.key(i));
                            localStorage.setItem(key, JSON.stringify(user));
                            break;
                        }
                    }
                    if (Number(scoreEl2.textContent) >= 10) {
                        setTimeout(() => {
                            clearInterval(counter);
                            totalScore[1].textContent = (Number(totalScore[0].textContent)+Number(scoreEl2.textContent));
                            fourth.classList.toggle('current');
                            win2.classList.toggle('current');
                        }, 500)
                    }else if(Number(scoreEl2.textContent) < 10) {
                        setTimeout(() => {
                            clearInterval(counter);
                            fourth.classList.toggle('current');
                            fail.classList.toggle('current');
                        }, 500)
                    }
                }
                let str = '0' + min + ':';
                str += sec >= 10 ? sec :'0'+ sec;
                counterValue2.innerHTML = str;
                timeValue--;
            }, 1000)
            getImages1();
        });

        //////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////

        let game3list = document.querySelector(".game3-list");
        function getImages2() {
            for (let i = 0; i < game3list.children.length; i++){
                game3list.children[i].classList.add(`image-${i+1}`);
                game3list.children[i].classList.add(`animation-${i+1}`); 
            }
            game3list.children[0].classList.add("кролик");
            game3list.children[1].classList.add("тигр");
            game3list.children[2].classList.add("корова");
            game3list.children[3].classList.add("волк");
            game3list.children[4].classList.add("олень");
            game3list.children[5].classList.add("собака");
        }
        function getAnimal() {
            let rand = getRandomInt(0,length);
            if(rand==0){
                    return "кролик";
                }else if(rand==1){
                    return "тигр";
                }else if(rand==2){
                    return "корова";
                }else if(rand==3){
                    return "волк";
                }else if(rand==4){
                    return "олень";
                }else if(rand==5){
                    return "собака";
                }
        }

        let nextBtn2 = document.querySelector(".next-btn-2");
        let scoreEl3 = document.querySelector('.score3');
        let counterValue3= document.querySelector('.counter3');
        let request = document.querySelector(".request");
        let animal = getAnimal();
        
        nextBtn2.addEventListener('click', (e) => {;
            request.textContent = animal;
            win2.classList.toggle('current');
            fiveth.classList.toggle('current');
            timeValue = 60;
            counter = setInterval(function () {
                min = Math.floor(timeValue / 60);
                sec = timeValue % 60;
                if (timeValue == 0) {
                    user.score += Number(scoreEl3.textContent);
                    for (let i = 0; i < localStorage.length; i++) {
                        
                        let userJson = JSON.parse(localStorage.getItem(localStorage.key(i)));
                        if ((user.name == userJson.name) && (user.score > userJson.score)) {
                            let key = localStorage.key(i);
                            localStorage.removeItem(localStorage.key(i));
                            localStorage.setItem(key, JSON.stringify(user));
                            break;
                        }
                    }
                    if (Number(scoreEl3.textContent) >= 10) {
                        setTimeout(() => {
                            clearInterval(counter);
                            totalScore[2].textContent = (Number(totalScore[1].textContent)+Number(scoreEl3.textContent));
                            fiveth.classList.toggle('current');
                            win3.classList.toggle('current');
                        }, 500)
                    }else if(Number(scoreEl3.textContent) < 10) {
                        setTimeout(() => {
                            clearInterval(counter);
                            fiveth.classList.toggle('current');
                            fail.classList.toggle('current');
                        }, 500)
                    }
                }
                let str = '0' + min + ':';
                str += sec >= 10 ? sec :'0'+ sec;
                counterValue3.innerHTML = str;
                timeValue--;
            }, 1000)
            getImages2();
        });
        for (let i = 0; i < game3list.children.length; i++) {
            game3list.children[i].onclick = function () {
                if (game3list.children[i].classList[3] == animal) {
                    scoreEl3.textContent = Number(scoreEl3.textContent) + 1;
                } else {
                    scoreEl3.textContent = Number(scoreEl3.textContent) - 1;
                }
                request.textContent = "";
                animal = getAnimal();
                request.textContent = animal;
                setTimeout(getImages2, 600);
            }
        }
        
    </script>
</body>
</html>